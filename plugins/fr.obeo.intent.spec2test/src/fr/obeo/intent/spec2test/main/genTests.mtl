[comment encoding = UTF-8 /]
[module genTests('http://www.eclipse.org/intent/specification/1.0')]
[import fr::obeo::intent::spec2test::files::ui::genTestSuite /]
[import fr::obeo::intent::spec2test::files::ui::genContext /]
[import fr::obeo::intent::spec2test::files::ui::genContextMenuHelper /]
[import fr::obeo::intent::spec2test::files::ui::genAbstractContext /]
[import fr::obeo::intent::spec2test::files::ui::genIContext /]
[import fr::obeo::intent::spec2test::files::ui::genContextStatement /]
[import fr::obeo::intent::spec2test::files::genAutomationUtils/]

[template public genTests(specification : Specification)]
[comment @main/]
[genTestSuites(specification, TestType::ui)/]
[genTestSuites(specification, TestType::unit)/]
[genTestSuites(specification, TestType::plugin)/]
[genManualTestSuites(specification)/]
[genTestFeaturesStatus(specification)/]

[comment Contexts/]
[for (contxt : Context | specification.automationLayer._context)]
	[genContext(contxt)/]
[/for]

[genContextMenuHelper()/]
[genAbstractContext()/]
[genIContext()/]
[genContextStatement()/]
[/template]

[template public genTestSuites (specification : Specification, type : TestType) ]
[genTestSuite(specification, type)/]
[for (feature : NamedElement | getTestTypeFeatures(specification.features, type))]
	[genTestSuite(feature, type)/]
[/for]
[/template]

[template public genManualTestSuites(specification : Specification)]
	[file (specification.name+'ManualTestSuite.txt', false, 'UTF-8')]
[for (feature : Feature | getTestTypeFeatures(specification.features, TestType::manual))]
[getTestManualFeatures(feature)/]
[/for]
[/file]
[/template]

[template public getTestManualFeatures(feature : Feature)]
Feature : [feature.name/]
	[for (story : Story | feature.stories)]
	Story : [story.name/]
		[for (scenario : Scenario | story.scenarios)]
		Scenario : [scenario.name/]
			[for (given : Context | scenario.given)]
			Given [given.name/]
			[/for]
			[for (when : Action | scenario.when)]
			When [when.name/]
			[/for]
			[for (_then : Behaviour | scenario._then)]
			Then [_then.name/]
			[/for]
		[/for]
	[/for]
[for (subFeature : Feature | getTestTypeFeatures(feature.features, TestType::manual))]
	[getTestManualFeatures(subFeature)/]
[/for]
[/template]

[template public genTestFeaturesStatus(specification : Specification)]
	[file (specification.name+'TestCoverageStatus.txt', false, 'UTF-8')]
[for (feature : Feature | specification.eAllContents(Feature))]
	Feature : [feature.name/]
	Nb automatic tests :[getAutomaticTestsStatistics()/]
	Nb manual tests :[getManualTestsStatistics()/]
[/for]
[/file]
[/template]

[template public getAutomaticTestsStatistics (feature : Feature) post (trim())]
[if (feature.eAllContents(Scenario).eAllContents(TestGenerationNote)->size()>0)]
[(feature.eAllContents(Scenario).eAllContents(TestGenerationNote)->select(type<>TestType::manual)->size()/feature.eAllContents(Scenario).eAllContents(TestGenerationNote)->size())*100/]
[else]
	0
[/if]
[/template]
[template public getManualTestsStatistics (feature : Feature) post (trim())]
[if (feature.eAllContents(Scenario).eAllContents(TestGenerationNote)->size()>0)]
[(feature.eAllContents(Scenario).eAllContents(TestGenerationNote)->select(type=TestType::manual)->size()/feature.eAllContents(Scenario).eAllContents(TestGenerationNote)->size())*100/]
[else]
	0
[/if]
[/template]